//#include "xy_api.h"
#include "xy_http_client.h"
#include "at_http.h"
#include "http_api.h"

typedef struct req_Http
{
	char method;
	char path[50];
}Http_req_t;

Http_req_t Http_req[7] = {
	{0 , "/"},
	{1 , "/users"},
	{2 , "/users"},
	{3 , "/users"},
	{4 , "/users"},
	{0 , "/users/d"},
	{0 , "/users/f"}
};

char *sever_cert ="2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d49494470544343416f30434641612b6c596c5a554e57793962487a6f486a77665270557446757a4d413047435371475349623344514542437755414d49474f0a4d517377435159445651514745774a44546a45514d4134474131554543417748536d6c68626d6454645445514d4134474131554542777748546d4675536d6c750a5a7a454c4d416b47413155454367774357466b78476a415942674e564241734d45564e765a6e523359584a6c494642735958526d62334a744d513477444159440a56515144444156495957356b655445694d43414743537147534962334451454a41525954643246755a32684165476c7565576c7a5a5731704c6d4e76625441650a467730794d4445774d6a63774e7a49334d6a4661467730794d5445774d6a63774e7a49334d6a46614d49474f4d517377435159445651514745774a44546a45510a4d4134474131554543417748536d6c68626d6454645445514d4134474131554542777748546d4675536d6c755a7a454c4d416b47413155454367774357466b780a476a415942674e564241734d45564e765a6e523359584a6c494642735958526d62334a744d5134774441594456515144444156495957356b655445694d4341470a43537147534962334451454a41525954643246755a32684165476c7565576c7a5a5731704c6d4e7662544343415349774451594a4b6f5a496876634e415145420a42514144676745504144434341516f4367674542414e434e6c2b384c797a52535547766a7446664f7559714c43637549392b71447a6c52573249414942657a570a574571544a65584a7947733775612f614f2f5a6f6f685944397961654344326856526d782f6273304367644d67494131694e636d38385a55436a34314a7351620a504e5242417a316a4c7a37526b64534b5278666b37325132474c74652f736541684e6478315a62736a4b724e487742642b6867784e516634555a7a62413941630a4a397a6c706d4a384e665071694575305a50734f37636d6334712b702b6f7253794142506d6975356a6d6a4c4e787374752f2b624c3175506461624e796e30550a686b7151677a71433442595331394e397856794b3743314773777638594d723042453135554f7850514a5854656e4a6f4d674b5648364f51446f6630756a2b790a6e2f376b4d6b77324d6b306a44515163344230395a7471345736634546466374756e55563259317553714543417745414154414e42676b71686b6947397730420a4151734641414f4341514541555466357972693735785753744e6934305067483361642b494e564148564c49766d665179486c36764e46525a2f59666f5278620a47624e3454425146486e3768674c574671626f324a666245756c424e7a4b4c6d5a6d7a664a6f4450624c57357346545a6977384a7758497837346f44364b374e0a6777394c73642f74356756366142655645563871735a363964554852437667624c3944546f6242454a6b4a514f55505133347967573076336f6d68455774304e0a327a507539685a4a6c504c734264677a734343353466505a4c574d754c3746524a6a307a6445483349784762616e4d55636a456d69334f63573556696c6e41630a5872387a5a6d6536704f507247425a714d79306366546551716761366439556a616e79724c76622f65657047694446396279714e67544454516c5239546758650a33464438772b5441697844676739783233796568556e575177546f585967325a48513d3d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d";
char *client_cert="2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d49494470544343416f30434641506d7858694a474a552f2b6c317a4831725869754b5353424f414d413047435371475349623344514542437755414d49474f0a4d517377435159445651514745774a44546a45514d4134474131554543417748536d6c68626d6454645445514d4134474131554542777748546d4675536d6c750a5a7a454c4d416b47413155454367774357466b78476a415942674e564241734d45564e765a6e523359584a6c494642735958526d62334a744d513477444159440a56515144444156495957356b655445694d43414743537147534962334451454a41525954643246755a32684165476c7565576c7a5a5731704c6d4e76625441650a467730794d4445774d6a67774f4445304d545661467730794d5445774d6a67774f4445304d5456614d49474f4d517377435159445651514745774a44546a45510a4d4134474131554543417748536d6c68626d6454645445514d4134474131554542777748546d4675536d6c755a7a454c4d416b47413155454367774357466b780a476a415942674e564241734d45564e765a6e523359584a6c494642735958526d62334a744d5134774441594456515144444156495957356b655445694d4341470a43537147534962334451454a41525954643246755a32684165476c7565576c7a5a5731704c6d4e7662544343415349774451594a4b6f5a496876634e415145420a42514144676745504144434341516f4367674542414e7a61334248314c78726a4e79356f753643646437685555703873794e4177326c763034416a71696655510a347979727934716779364b767a6635644846374143563265396578716c6b71666279796e58626b545747493850765a4a73783139634d6c667842724d39754d370a542f34344c6d7549487054716c54312f354f4e7767664959555253516b3856327a2f5370717052754c744a5a6d735979454b2b537a5364744d584d7a612f73630a5a4f70767532636b4c496c36516c4564736d3276424279413767332b5643566267456c48424f2f2b76594e592f2b78696c5a5a5359304c54746b4b77363475500a4f71742f614c53785867706f79542b646c3249766e7252366b7a73373673304c7230487870505931613271694f74394a64663341734d425468483476624970610a67774430366978534a794f4c613261556f627952566c6b724d334e632f54513233613966526e365850786b43417745414154414e42676b71686b6947397730420a4151734641414f4341514541786363577a745672636e686c7652386776374d4134676a67506c6d6b6166656a73537a326968374636522b35477562784a4b37660a33735175533577436e4d704c4b774c64523073714c336b56716474464d556f352b366c673744533137544e3169674e31644f61656937634275374f312b4a65520a464a536c6171472f76337443507677655753306b7477314c78587167396152435736376b4e31476c6c642f3046544c79717a737568456f43333448502f7254510a6e754e78426735336b626b75453749312b30776c475265394763613348714b6846687037716657326c724b564d474439417267623943436837674335596666430a564959724f625653714d383457584b59755933413471394b356b504365433649464454534c4b6278574f4655566b51475a7247552b5335736856754e77686c450a4e5334566c7249743531334e612b466c313742745a7945506f354d694365724358673d3d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d";
char *client_pk = "2d2d2d2d2d424547494e205253412050524956415445204b45592d2d2d2d2d0a4d4949457051494241414b4341514541334e72634566557647754d334c6d69376f4a3133754652536e797a4930444461572f5467434f714a3952446a4c4b764c0a6971444c6f712f4e2f6c30635873414a585a373137477157537039764c4b646475524e59596a772b396b6d7a4858317779562f4547737a32347a74502f6a67750a613467656c4f715650582f6b3433434238686852464a435478586250394b6d716c473475306c6d61786a495172354c4e4a323078637a4e722b78786b366d2b370a5a79517369587043555232796261384548494475446635554a56754153556345372f363967316a2f37474b566c6c4a6a51744f3251724472693438367133396f0a744c4665436d6a4a5035325859692b65744871544f7a76717a5175765166476b396a56726171493633306c312f63437777464f4566693973696c7144415054710a4c46496e493474725a705368764a46575753737a63317a394e446264723139476670632f4751494441514142416f4942415143654a625a717759682b6c322b2f0a4d7334515946494855354a7157765a645a6d346d5a503438524436506c77306c77737359744c573942476a636d53346b68787a74786c4e52664b32734e2b697a0a4d424844347039716b4c75425078736370654f717634473873304b6a5371696f595043556e623951595836477346746c706633584c7952344e6d4d71686a36350a63766b73476f34366f47466452534a2f7076357a4768544c366d6d4c514e2b6b665570366c5772413263684444366d6665375357387a516851776c426d6a744c0a4e746f6348467558716930463863364c306448326f687639626e3353437456636833593365693451653370504f6a4b5a476e6b4c47664952774d72544766734f0a7662774c77685945516170656e7a416b637556496135347037332f4c35767133752f49364d58516e65534e36615853676f66504376654a505037767a65486a760a6e53564c4e4a5431416f47424150316d314a6f72653955634b696c5364343231446f6d73414c2f31353533734734366e35596e765a537a76655055664438582f0a59426d654c6c3734626f7265624535426c4f664833383170424931394a383944446d4f316b4c3931536c4c647139424c4b4d334a494a755a6b7a4b6b4142746f0a6646744b332f7844697151384f37644f6f4b617978645533722f4859564171472f4261562b786961566f714d2f506e36566c304e4f545550416f4742414e38650a6d46366d38553577366d356e7748696971794d566a4c2b4157443732504c39754f384d7a4f79666c4a72566e4547594139545a335631355a396a555a4e5649340a4a6f7835523078666a5455624a7156796d6b4c46676f306a4c714e47314c59335835705774554d717a2f666e4c746c613357356c786961776c57776f416443700a695a592b566461714e617967312b344d4f6145653058796378345856416739764d755a6744466c58416f4742414c6f442b337431416b464e6e4a476137524a450a582f696d49434c4b4e4132556e69495a6c4147756a396e747253426266657539374f4442596f377131644c784e6859345245506c554a2f73514b4251794b46340a4f783773304f594c427456507a6d6c6f55767246637a396c2f453148594b432b45644f2b596a412f7349326866634378596e4d63647564764b715268526b67340a454f50506b335462447a354541777a4b5051327677466633416f47416368644c4174754b2b506c305a78425773316b362b61334455776c6d466f7744644541420a2f3062724d504e555839356233453052467444667444643856707156555832302b492f726a586f753073455865664b6f50777951505775494a61584b6a344b780a4f464b7554624a4f7467315a50337666547478722f73793947356b356c47476449563675746835445a417137583961516758736f302f653362784146426139750a373636646f664543675945413151724c34745251484f43755859594e56354e39594d56314531774a663369446d725171546938644a3867346a62707a755265670a516b2b56782f74696d477a6b35744d6b327077644a7a544f4336795a637274364f505147574938463568424c79636447526b6a4248677572427241772f7146670a4d2f58527255686b424a5777413757714a434977785855676f6642353161466d71704f47435864333439527731746a5768654e4f5949673d0a2d2d2d2d2d454e44205253412050524956415445204b45592d2d2d2d2d";
char *host ="https://139.224.131.190:3001";

char *auth_user = NULL;
char *auth_passwd = NULL;

char *header = "6170692D6B65793A4A4459694B794B6669344934734F4657654A734934533343626C303D0d0a";
char *content = "7b2252504d223a32327d";

static void  https_task_demo(void *args)
{
	(void) args;

	int http_id;
	char *path = NULL;
	char method = 0;
	char *buf = NULL;
	unsigned int recv_header_len = 0;
	unsigned int recv_body_len = 0;
	int i = 0;
	int ret = 0;

		for(i = 0; i < 6; i++)
		{
			/* host填写时必须带前缀http:// 或者https:// */
			/* 用户名 密码 选填*/
			http_id = xy_http_create(host, auth_user, auth_passwd);
			if(http_id == XY_ERR)
			{
				xy_assert(0);
			}

			/* HTTPS：服务器证书必填 */
			ret = xy_http_cfg(http_id, SEVER_CERT,sever_cert, HEX_CHARACTER);
			if(ret == XY_ERR){
				xy_assert(0);
			}

			/* 建议 客户端证书可以不填：此时作单向验证  */
			ret = xy_http_cfg(http_id, CLIENT_CERT,client_cert, HEX_CHARACTER);
			if(ret == XY_ERR){
				xy_assert(0);
			}

			/* 建议 客户端证书可以不填：此时作单向验证  */
			ret = xy_http_cfg(http_id, CLIENT_PK,client_pk, HEX_CHARACTER);
			if(ret == XY_ERR){
				xy_assert(0);
			}
			
			/* 增加用户header， HEX_CHARACTER模式：16进制传输， 也可选择ESCAPE_MECHANISM： 字符串传输*/
			/* 若新增多条header：应在header中输入\r\n 表示回车换行*/
			ret = xy_http_header(http_id, header, HEX_CHARACTER);
			if(ret == XY_ERR){
				xy_assert(0);
			}

			/* 增加content， HEX_CHARACTER模式：16进制传输， 也可选择ESCAPE_MECHANISM： 字符串传输*/
			ret = xy_http_content(http_id, content, HEX_CHARACTER);
			if(ret == XY_ERR)
				xy_assert(0);

			/* 等待驻网成功*/
			while(xy_wait_tcpip_ok(10) != XY_OK);

			/* 建立socket连接，每次请求前都应先调用此接口*/
			ret = xy_http_connect(http_id);
			if(ret == XY_ERR)
				xy_assert(0);

			method = Http_req[i].method;
			path = Http_req[i].path;


			/* 发起request请求， method可选	
				HTTP_METHOD_GET = 0,
				HTTP_METHOD_POST,
				HTTP_METHOD_PUT,
				HTTP_METHOD_DELETE,
				HTTP_METHOD_HEAD,*/
			ret = xy_http_request(http_id, method, path);
			if(ret == XY_ERR)
				xy_assert(0);
more_header:
			buf = xy_zalloc(1025);
			/* 接受header，HTTP_FOREVER 表示永久等待，可选择其他时间（单位ms） */
			recv_header_len = xy_http_recv_header(http_id , buf, 1024, HTTP_FOREVER);
			if(recv_header_len >= 0)
			{
				/* 此处输出至AT口，实际buf处理由客户决定*/
				*(char *)(buf + recv_header_len) = '\0';
				send_debug_str_to_at_uart(buf);	
			}
			xy_free(buf);

			/* 查询是否还有header待接收*/
			if( header_recvlist_empty(http_id) != XY_TRUE )
			{
				goto more_header;
			}

			if(HTTP_METHOD_HEAD != method)
			{
more_body:
				buf = xy_zalloc(1024+1);
				/* 接受body，HTTP_FOREVER 表示永久等待，可选择其他时间（单位ms） */
				recv_body_len = xy_http_recv_body(0 , buf, 1024, HTTP_FOREVER);		// delay 100ms for data collection
				if(recv_body_len >= 0 )
				{
				/* 此处输出至AT口，实际buf处理由客户决定*/
					*(char *)(buf + recv_body_len) = '\0';

					/* ************user_function*****************/


					send_debug_str_to_at_uart(buf);			//For example: output through AT COM.


					/******************* user_function***********/
				}

				xy_free(buf); 

				/* 查询是否还有body待接收*/
				if( body_recvlist_empty(http_id) != XY_TRUE )
				{
					goto more_body;
				}
			}
				xy_http_close(http_id);
		}

	osThreadExit();
	return;
}








/* 15K data transfer example*/

/* 0  for get request , /users/f stores 15K data*/
Http_req_t Http_req3[15] = {
	{0 , "/users/d"},
	{0 , "/users/f"},
	{2 , "/users"},
	{0 , "/users/d"},
	{0 , "/users/f"},
	{0 , "/users/d"},
	{0 , "/users/f"},
	{0 , "/users/f"},
	{0 , "/"},
	{1 , "/users"},
	{0 , "/users/d"},
	{2 , "/users"},
	{3 , "/users"},
	{0 , "/users/f"},
	{4 , "/users"},
};

char *host3 ="http://139.224.131.190:3000";
char *auth_user3 = NULL;
char *auth_passwd3 = NULL;

char *header3 = "6170692D6B65793A4A4459694B794B6669344934734F4657654A734934533343626C303D0d0a";
char *content3 = "7b2252504d223a32327d";

int recv_len = 0;
static void  http_task_demo3(void *args)
{
	(void) args;

	int http_id;
	char *path = NULL;
	char method = 0;
	char *buf = NULL;
	unsigned int recv_header_len = 0;
	unsigned int recv_body_len = 0;
	int i = 0;
	int ret = 0;

		for(i = 0; i < 15; i++)
		{
			recv_len = 0;
			/* host填写时必须带前缀http:// 或者https:// */
			/* 用户名 密码 选填*/
			http_id = xy_http_create(host3, auth_user3, auth_passwd3);
			if(http_id == XY_ERR)
			{
				xy_assert(0);
			}

			/* 增加用户header， HEX_CHARACTER模式：16进制传输， 也可选择ESCAPE_MECHANISM： 字符串传输*/
			/* 若新增多条header：应在header中输入\r\n 表示回车换行*/
			ret = xy_http_header(http_id, header3, HEX_CHARACTER);
			if(ret == XY_ERR){
				xy_assert(0);
			}

			/* 增加content， HEX_CHARACTER模式：16进制传输， 也可选择ESCAPE_MECHANISM： 字符串传输*/
			ret = xy_http_content(http_id, content3, HEX_CHARACTER);
			if(ret == XY_ERR)
				xy_assert(0);

			/* 等待驻网成功*/
			while(xy_wait_tcpip_ok(10) != XY_OK);

			/* 建立socket连接，每次请求前都应先调用此接口*/
			ret = xy_http_connect(http_id);
			if(ret == XY_ERR)
				xy_assert(0);

			method = Http_req3[i].method;
			path = Http_req3[i].path;

			/* 发起request请求， method可选	
				HTTP_METHOD_GET = 0,
				HTTP_METHOD_POST,
				HTTP_METHOD_PUT,
				HTTP_METHOD_DELETE,
				HTTP_METHOD_HEAD,*/
			ret = xy_http_request(http_id, method, path);
			if(ret == XY_ERR)
				xy_assert(0);
more_header:
			buf = xy_zalloc(1025);
			/* 接受header，HTTP_FOREVER 表示永久等待，可选择其他时间（单位ms） */
			recv_header_len = xy_http_recv_header(http_id , buf, 1024, HTTP_FOREVER);
			if(recv_header_len >= 0)
			{
				/* print header on AT com*/
				*(char *)(buf + recv_header_len) = '\0';
				send_debug_str_to_at_uart(buf);	
			}

			xy_free(buf); 

			/* 查询是否还有header待接收*/
			if( header_recvlist_empty(http_id) != XY_TRUE )
			{
				goto more_header;
			}


			if(HTTP_METHOD_HEAD != method)
			{
more_body:
				buf = xy_zalloc(4*1024+1);
				/* 接受body，HTTP_FOREVER 表示永久等待，可选择其他时间（单位ms） */
				recv_body_len = xy_http_recv_body(0 , buf, 4*1024, HTTP_FOREVER);		// delay 100ms for data collection
				if(recv_body_len >= 0 )
				{
					*(char *)(buf + recv_body_len) = '\0';

					/* ************user_function*****************/
					/* buf	operation	*/
					/* buf	operation	*/
					send_debug_str_to_at_uart(buf);			//For example: output through AT COM.
					/* buf	operation	*/
					/* buf	operation	*/
					/******************* user_function***********/
				}
				recv_len+=recv_body_len;
				xy_free(buf); 

				/* 查询是否还有body待接收*/
				if( body_recvlist_empty(http_id) != XY_TRUE )
				{
					goto more_body;
				}
			}
			xy_http_close(http_id);
		}
	osThreadExit();
	return;
}

void http_demo_init()
{
	osThreadAttr_t thread_attr = {0};
		
	thread_attr.name	   = "https_task_demo";
	thread_attr.priority   = osPriorityNormal;
	thread_attr.stack_size = 0x3000;
	osThreadNew((osThreadFunc_t)(https_task_demo),NULL,&thread_attr);
}
